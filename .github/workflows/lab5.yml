coverage:
  runs-on: ubuntu-latest
  needs: build-and-test
  steps:
    - uses: actions/checkout@v4
      
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential cmake lcov g++-11
        
    - name: Build with coverage
      run: |
        cd banking
        mkdir coverage-build
        cd coverage-build
        cmake .. -DENABLE_COVERAGE=ON
        make
        
    - name: Run tests and generate coverage data
      run: |
        cd banking/coverage-build
        # Устанавливаем переменные окружения для генерации .gcda файлов
        export GCOV_PREFIX=$(pwd)
        export GCOV_PREFIX_STRIP=0
        ./banking_tests
        
    - name: Generate coverage report
      run: |
        cd banking/coverage-build
        # Собираем данные покрытия
        lcov --capture --directory . --output-file coverage.info
        lcov --remove coverage.info '/usr/*' --output-file coverage.info
        genhtml coverage.info --output-directory coverage
        
    - name: Upload coverage report
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: banking/coverage-build/coverage
